// the following code creates a tremolo effect.
// the wavetable is used to generator a sine wave in the range
// of 0 - 1.0.
// the input signal is then multiplied by the sine waveform.
// each sample of the input is multiplied by current value of the waveform
// this causes the amplitude of the signal to vary between 0 and the original
// maximum signal amplitude.

#include "mbed.h" // include the mbed classes, structures and groups.
float x,x1,y,y1,z,z1; 
int n = 0;
int n1 = 0;
AnalogIn analog_value(A0); // analog input. A0 pin on nucleo L152 & F303K8.
AnalogOut my_output(PA_4); // analog output. A2 pin on nucleo L152-A2 & A3 pin on F303K8.
AnalogIn Speed(A1); // analog input for pot to control speed of tremolo. L152-A1 F303K8-A1
AnalogIn Depth(A3); // analog input for pot to control depth of tremolo. L152-A3 F303K8-A3
Ticker s1hz_tick; // initialise ticker function
float Sp = 1; // tremolo speed is initialised to 1.
float De = 1; // tremolo depth is initialised to 1.

void s1hz_task(void); // initialise task function

// sine waveteable
float wave[1000] =	{32767,32973,33179,33385,33590,33796,34002,34208,34413,34619,34824,
35030,35235,35441,35646,35851,36056,36260,36465,36670,36874,37078,37282,37486,37690,37893,
38096,38299,38502,38705,38907,39109,39311,39513,39714,39915,40116,40316,40516,40716,40916,
41115,41314,41513,41711,41909,42106,42304,42500,42697,42893,43088,43284,43478,43673,43867,
44060,44253,44446,44638,44830,45021,45211,45402,45591,45781,45969,46157,46345,46532,46719,
46905,47090,47275,47459,47643,47826,48009,48191,48372,48553,48733,48912,49091,49269,49447,
49624,49800,49976,50151,50325,50498,50671,50843,51014,51185,51355,51524,51693,51860,52027,
52193,52359,52523,52687,52850,53013,53174,53335,53495,53654,53812,53969,54126,54282,54437,
54591,54744,54896,55047,55198,55348,55496,55644,55791,55937,56082,56226,56370,56512,56653,
56794,56933,57072,57210,57346,57482,57617,57750,57883,58015,58146,58275,58404,58532,58658,
58784,58909,59032,59155,59276,59397,59516,59635,59752,59868,59984,60098,60211,60323,60434,
60543,60652,60760,60866,60971,61076,61179,61281,61382,61481,61580,61677,61774,61869,61963,
62056,62148,62238,62328,62416,62503,62589,62674,62757,62840,62921,63001,63079,63157,63233,
63309,63383,63455,63527,63597,63666,63734,63801,63867,63931,63994,64056,64116,64175,64233,
64290,64346,64400,64453,64505,64556,64605,64653,64700,64745,64790,64833,64874,64915,64954,
64992,65029,65064,65098,65131,65163,65193,65222,65250,65276,65301,65325,65348,65369,65389,
65408,65425,65441,65456,65470,65482,65493,65503,65511,65518,65524,65529,65532,65534,65535,
65534,65532,65529,65524,65518,65511,65503,65493,65482,65470,65456,65441,65425,65408,65389,
65369,65348,65325,65301,65276,65250,65222,65193,65163,65131,65098,65064,65029,64992,64954,
64915,64874,64833,64790,64745,64700,64653,64605,64556,64505,64453,64400,64346,64290,64233,
64175,64116,64056,63994,63931,63867,63801,63734,63666,63597,63527,63455,63383,63309,63233,
63157,63079,63001,62921,62840,62757,62674,62589,62503,62416,62328,62238,62148,62056,61963,
61869,61774,61677,61580,61481,61382,61281,61179,61076,60971,60866,60760,60652,60543,60434,
60323,60211,60098,59984,59868,59752,59635,59516,59397,59276,59155,59032,58909,58784,58658,
58532,58404,58275,58146,58015,57883,57750,57617,57482,57346,57210,57072,56933,56794,56653,
56512,56370,56226,56082,55937,55791,55644,55496,55348,55198,55047,54896,54744,54591,54437,
54282,54126,53969,53812,53654,53495,53335,53174,53013,52850,52687,52523,52359,52193,52027,
51860,51693,51524,51355,51185,51014,50843,50671,50498,50325,50151,49976,49800,49624,49447,
49269,49091,48912,48733,48553,48372,48191,48009,47826,47643,47459,47275,47090,46905,46719,
46532,46345,46157,45969,45781,45591,45402,45211,45021,44830,44638,44446,44253,44060,43867,
43673,43478,43284,43088,42893,42697,42500,42304,42106,41909,41711,41513,41314,41115,40916,
40716,40516,40316,40116,39915,39714,39513,39311,39109,38907,38705,38502,38299,38096,37893,
37690,37486,37282,37078,36874,36670,36465,36260,36056,35851,35646,35441,35235,35030,34824,
34619,34413,34208,34002,33796,33590,33385,33179,32973,32767,32561,32355,32149,31944,31738,
31532,31326,31121,30915,30710,30504,30299,30093,29888,29683,29478,29274,29069,28864,28660,
28456,28252,28048,27844,27641,27438,27235,27032,26829,26627,26425,26223,26021,25820,25619,
25418,25218,25018,24818,24618,24419,24220,24021,23823,23625,23428,23230,23034,22837,22641,
22446,22250,22056,21861,21667,21474,21281,21088,20896,20704,20513,20323,20132,19943,19753,
19565,19377,19189,19002,18815,18629,18444,18259,18075,17891,17708,17525,17343,17162,16981,
16801,16622,16443,16265,16087,15910,15734,15558,15383,15209,15036,14863,14691,14520,14349,
14179,14010,13841,13674,13507,13341,13175,13011,12847,12684,12521,12360,12199,12039,11880,
11722,11565,11408,11252,11097,10943,10790,10638,10487,10336,10186,10038,9890,9743,9597,
9452,9308,9164,9022,8881,8740,8601,8462,8324,8188,8052,7917,7784,7651,7519,7388,7259,7130,
7002,6876,6750,6625,6502,6379,6258,6137,6018,5899,5782,5666,5550,5436,5323,5211,5100,4991,
4882,4774,4668,4563,4458,4355,4253,4152,4053,3954,3857,3760,3665,3571,3478,3386,3296,3206,
3118,3031,2945,2860,2777,2694,2613,2533,2455,2377,2301,2225,2151,2079,2007,1937,1868,1800,
1733,1667,1603,1540,1478,1418,1359,1301,1244,1188,1134,1081,1029,978,929,881,834,789,744,
701,660,619,580,542,505,470,436,403,371,341,312,284,258,233,209,186,165,145,126,109, 93, 
78, 64, 52, 41, 31, 23, 16, 10,  5,  2,  0,  0,  0,  2,  5, 10, 16, 23, 31, 41, 52, 64,
78, 93,109,126,145,165,186,209,233,258,284,312,341,371,403,436,470,505,542,580,619,660,
701,744,789,834,881,929,978,1029,1081,1134,1188,1244,1301,1359,1418,1478,1540,1603,1667,
1733,1800,1868,1937,2007,2079,2151,2225,2301,2377,2455,2533,2613,2694,2777,2860,2945,3031,
3118,3206,3296,3386,3478,3571,3665,3760,3857,3954,4053,4152,4253,4355,4458,4563,4668,4774,
4882,4991,5100,5211,5323,5436,5550,5666,5782,5899,6018,6137,6258,6379,6502,6625,6750,6876,
7002,7130,7259,7388,7519,7651,7784,7917,8052,8188,8324,8462,8601,8740,8881,9022,9164,9308,
9452,9597,9743,9890,10038,10186,10336,10487,10638,10790,10943,11097,11252,11408,11565,
11722,11880,12039,12199,12360,12521,12684,12847,13011,13175,13341,13507,13674,13841,14010,
14179,14349,14520,14691,14863,15036,15209,15383,15558,15734,15910,16087,16265,16443,16622,
16801,16981,17162,17343,17525,17708,17891,18075,18259,18444,18629,18815,19002,19189,19377,
19565,19753,19943,20132,20323,20513,20704,20896,21088,21281,21474,21667,21861,22056,22250,
22446,22641,22837,23034,23230,23428,23625,23823,24021,24220,24419,24618,24818,25018,25218,
25418,25619,25820,26021,26223,26425,26627,26829,27032,27235,27438,27641,27844,28048,28252,
28456,28660,28864,29069,29274,29478,29683,29888,30093,30299,30504,30710,30915,31121,31326,
31532,31738,31944,32149,32355,32561};

int main()
{
    s1hz_tick.attach_us(&s1hz_task,50*Sp); // wavetable generator function is called and 
    				// the frequency of how often it is called is change with the pot.
    
    while(1){
        x = analog_value.read();//input read from analog input pin A0 in range of 0 - 1.0
        Sp = Speed.read(); 		// speed is read from analog input A1 in range of 0 - 1.0.
        De = Depth.read(); 		// depth is read from analog input A3 in range of 0 - 1.0.
        y = (x*z1); 			// input x is multiplied by sine wave z1.
        my_output.write(y); 	// y is written to analog output pin A2.
        }
}

void s1hz_task(void)
{
    y1 = (wave[n1]); 	// every time the function is called the wavetable is incremented
    n1++;				// the current value of the wavetable is divided by 65535 in
    z1 = (y1/65535)*De;	// order to get the output in the range of 0 - 1.0. this value
    if (n1 == 1000)		// is then multiplied by the value of the depth input from the
        {				// pot which will also be in the range of 0 - 1.0.
            n1 = 0;
        }
}